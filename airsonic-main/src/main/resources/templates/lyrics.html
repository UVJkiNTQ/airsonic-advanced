<!DOCTYPE html>
<html><head>
    <th:block th:replace="~{head :: common_head}" />
    <th:block th:replace="~{jquery}" />
    <th:block th:replace="~{websocket}" />
    <title th:text="#{lyrics.title}"></title>

    <script type="text/javascript" th:inline="javascript">
        // independent page, so StompClient does not belong to window.top
        const hasLyrics = /*[[${view.lyrics != null}]]*/ false;
        function init() {
            StompClient.subscribe("lyrics.html", {
                "/user/queue/lyrics/get": function(msg) {
                    getLyricsCallback(JSON.parse(msg.body));
                }
            }, function() {
                if (hasLyrics) {
                    $("#wait").css("display", "none");
                    $("#lyrics").css("display", "inline");
                    $("#noLyricsFound").css("display", "none");
                } else {
                    $("#wait").css("display", "inline");
                    getLyrics('[(${view.artist})]', '[(${view.song})]', '[(${view.id})]');
                }
            });
        }

        function getLyrics(artist, song, id) {
            $("#wait").css("display", "inline");
            $("#lyrics").css("display", "none");
            $("#noLyricsFound").css("display", "none");
            $("#tryLater").css("display", "none");
            StompClient.send("/app/lyrics/get", JSON.stringify({artist: artist, song: song, id: id}));
        }

        function getLyricsCallback(lyricsInfo) {
            $("#wait").css("display", "none");
            if (lyricsInfo.persisted === true) {
                location.reload();
                return;
            }
            if (lyricsInfo.tryLater) {
                $("#tryLater").css("display", "inline");
            } else {
                $("#noLyricsFound").css("display", "inline");
            }
            if (hasLyrics) {
                $("#lyrics").css("display", "inline");
            }
        }

        function search() {
            getLyrics($('#artist').val(), $('#song').val(), '[(${view.id})]');
        }
    </script>

</head>
<body class="mainframe bgcolor1" onload="init();">

<form action="#" onsubmit="search();return false;">
    <table>
        <tr>
            <td th:text="#{lyrics.artist}"></td>
            <td style="padding-left:0.50em"><input id="artist" type="text" size="40" th:value="${view.artist}" tabindex="1"/></td>
            <td style="padding-left:0.75em"><input type="submit" th:value="#{lyrics.search}" style="width:6em"
                                                   tabindex="3"/></td>
        </tr>
        <tr>
            <td th:text="#{lyrics.song}"></td>
            <td style="padding-left:0.50em"><input id="song" type="text" size="40" th:value="${view.song}" tabindex="2"/></td>
            <td style="padding-left:0.75em">
                <button type="button"
                        th:onclick="|location.href='@{/lyrics/edit(id=${view.id})}'|"
                        style="width:6em; display:inline-block; text-align:center;"
                        tabindex="4" th:text="#{common.edit}">
                </button>
            </td>
        </tr>
    </table>
</form>
<hr/>
<h2 id="wait" th:text="#{lyrics.wait}"></h2>
<h2 id="noLyricsFound" style="display:none" th:text="#{lyrics.nolyricsfound}"></h2>
<p id="tryLater" style="display:none"><b th:text="#{lyrics.trylater}"></b></p>

<div id="lyrics" style="display:none;">
    <h2 id="lyricsHeader" style="text-align:center;margin-bottom:1em"
        th:text="${(#strings.isEmpty(view.artist) ? '' : view.artist + ' - ') + #strings.defaultString(view.song, '')}"></h2>
    <div id="lyricsText">
        <th:block th:if="${view.lyrics}">
            <th:block th:each="str, stat : ${view.lyrics.split('\r\n|\r|\n', -1)}">
                <th:block th:text="${str}"/>
                <br th:if="${!stat.last}"/>
            </th:block>
        </th:block>
    </div>

    <p class="detail" style="text-align:right" th:text="${'lyrics from ' + view.source}">
    </p>
</div>

<hr/>
<p style="text-align:center">
    <a href="javascript:self.close()">[<span th:text="#{common.close}"></span>]</a>
</p>

</body>
</html>
